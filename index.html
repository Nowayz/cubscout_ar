<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi">
<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

<script type="module">
//import TWEEN from "https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.esm.min.js";

// Create 3D Canvas
var canvas = document.createElement('canvas');
canvas.style.width = '100%';
canvas.style.height = '100%';
canvas.style.overflow = 'hidden';
canvas.style.outline = 'none';
document.addEventListener('DOMContentLoaded', () => {
    document.body.style.margin = 0;
    document.body.append(canvas); // Add to document
    const engine = new BABYLON.Engine(canvas, true); // Generate the BABYLON 3D engine
    let scene;

    BABYLON.SceneLoader.Load("./", "cubscout_camp_packed.glb", engine, async (newScene) => {
        scene = newScene;

        /* 
            Add every mesh to a root TransformNode
            Then scale down the transform node so the scene isn't too big for AR
        */
        const root = new BABYLON.TransformNode("root");
        scene.addTransformNode(root);
        scene.meshes.forEach(mesh => {
            mesh.setParent(root);
        });
        root.scaling.scaleInPlace(.1);

        scene.createDefaultCamera(true, true, true);

        //var camera = new BABYLON.FreeCamera("camera1", new BABYLON.Vector3(8.701375517510863, 6.243523890856941, -11.397881634252279), scene);
        scene.createDefaultEnvironment({
            createGround: false,
            createSkybox: false,
        });
        
        // Create XR session
        const xr = await scene.createDefaultXRExperienceAsync({
            uiOptions: {
            sessionMode: "immersive-ar",
            },
        });
            
        // Set background color to sky blue
        scene.clearColor = new BABYLON.Color4((115/255)-.2, (215/255)-.2, (255/255)-.2, 1);

        // Add clipping plane for everything under 0, 0, 0
        const clippingPlane = new BABYLON.Plane(0, -1, 0, 0);
        scene.clipPlane = clippingPlane;

        scene.activeCamera.position = new BABYLON.Vector3(.1*8.701375517510863, .1*6.243523890856941, .1*-11.397881634252279);
        scene.activeCamera.setTarget(new BABYLON.Vector3(.1*-0.8146556368528799, .1*2.3272755722857514, .1*1.154336509716886));
        scene.activeCamera.fov =  .8;
        scene.activeCamera.wheelPrecision = 10;
        scene.activeCamera.pinchPrecision = 150;
        scene.activeCamera.inertia = 0;
        window.scene = scene;

        // find a mesh called "video_screen"
        const video_screen = scene.getMeshByName("video_screen");
        const video_material = new BABYLON.StandardMaterial("video_material", scene); 
        const video_texture  = new BABYLON.VideoTexture("video_tex", "video_small.mp4", scene);
        const voice_over = new BABYLON.Sound("voice_over", "Pack 395.mp3", scene, null, { 
            loop: false,
            autoplay: true 
        });
        
        video_material.diffuseTexture = video_texture;
        video_material.roughness = 1;
        video_material.emissiveColor = new BABYLON.Color3.White();
        video_screen.material = video_material;

        setTimeout(() => {
            // Play animation group called "Wave 01" then play animation group "Idle 01" when the first one is done
            const animation_group = scene.getAnimationGroupByName("Wave 01");
            animation_group.onAnimationEndObservable.add(() => {
                const animation_group_idle = scene.getAnimationGroupByName("Idle 01");
                animation_group_idle.play(true);
            });
            animation_group.play();
        }, 2000);
    });

    engine.runRenderLoop(() => {
        if(scene) {
            scene.render();
            //TWEEN.update();
        }
    });

    window.addEventListener("resize", () => {
        engine.resize();
    });

}, false);

</script>